# نظام متابعة العملاء - دليل الاستخدام

## نظرة عامة

تم إنشاء نظام متكامل لمتابعة العملاء يتيح مراجعة ملاحظات العملاء على صور أعمال الصيانة والرد عليها بشكل تفاعلي. يتضمن النظام:

- ✅ قاعدة بيانات متقدمة لتخزين التعليقات والردود
- ✅ واجهة API شاملة للتعامل مع البيانات
- ✅ واجهة مستخدم حديثة مع نظام محادثة تفاعلي
- ✅ نظام إشعارات للردود الجديدة
- ✅ إمكانية التعليق على الصور المحددة
- ✅ تنظيم التعليقات والردود في شكل محادثات متسلسلة

## المكونات الرئيسية

### 1. قاعدة البيانات (Database)

تم إضافة جدول جديد `ClientComment` في قاعدة البيانات مع الحقول التالية:

```prisma
model ClientComment {
  id              Int      @id @default(autoincrement())
  workPlanId      Int      // رقم خطة العمل
  atmCode         String   // كود المكينة
  imageUrl        String?  // رابط الصورة (اختياري)
  imageType       String?  // نوع الصورة: 'before' أو 'after'
  commentText     String   // نص التعليق
  commentBy       String   // اسم المعلق
  commentByRole   String   // دور المعلق: 'client' أو 'reviewer' أو 'admin'
  parentCommentId Int?     // معرف التعليق الأصلي للردود
  isRead          Boolean  // حالة القراءة
  status          String   // حالة التعليق: 'open' أو 'resolved' أو 'pending'
  createdAt       DateTime // تاريخ الإنشاء
  updatedAt       DateTime // تاريخ آخر تحديث
}
```

### 2. واجهات API

#### `/api/client-comments`

**GET** - جلب التعليقات
```typescript
// مثال على الطلب
GET /api/client-comments?workPlanId=123&atmCode=ATM001

// الاستجابة: مصفوفة من التعليقات مع الردود المتداخلة
[
  {
    id: 1,
    commentText: "الصورة غير واضحة",
    replies: [
      {
        id: 2,
        commentText: "تم رفع صورة جديدة"
      }
    ]
  }
]
```

**POST** - إضافة تعليق أو رد جديد
```typescript
// مثال على الطلب
POST /api/client-comments
{
  "workPlanId": 123,
  "atmCode": "ATM001",
  "commentText": "يرجى إعادة فحص المكينة",
  "commentBy": "أحمد محمد",
  "commentByRole": "client",
  "imageUrl": "https://...",  // اختياري
  "imageType": "before",      // اختياري
  "parentCommentId": 1        // للردود فقط
}
```

**PUT** - تحديث حالة التعليق
```typescript
POST /api/client-comments
{
  "id": 1,
  "isRead": true,
  "status": "resolved"
}
```

**DELETE** - حذف تعليق
```typescript
DELETE /api/client-comments?id=1
```

#### `/api/notifications`

**GET** - جلب الإشعارات والتعليقات غير المقروءة
```typescript
GET /api/notifications?userRole=client

// الاستجابة
{
  "unreadCount": 3,
  "recentComments": [...]
}
```

**POST** - وضع علامة مقروء على التعليقات
```typescript
POST /api/notifications
{
  "commentIds": [1, 2, 3]
}
```

### 3. صفحة مراجعة العميل (Client Review Page)

الموقع: `/client-review`

#### الميزات:

1. **عرض التقارير في جدول منظم**
   - رقم الطلب
   - تاريخ التنفيذ
   - كود المكينة
   - العنوان
   - الحالة

2. **نظام المحادثة التفاعلي**
   - عرض التعليقات في شكل محادثة
   - إمكانية الرد على أي تعليق
   - تمييز التعليقات حسب النوع (عميل/مراجع)
   - عرض حالة القراءة

3. **التعليق على الصور**
   - زر لإضافة تعليق لكل صورة
   - عرض نوع الصورة (قبل/بعد) في التعليق
   - عرض الصور بالحجم الكامل مع إمكانية التكبير

4. **إدارة التعليقات**
   - عداد للتعليقات غير المقروءة
   - حالات التعليق (مفتوح/تم الحل/قيد المعالجة)
   - نظام ردود متسلسل

### 4. نظام الإشعارات

#### مكون NotificationBell

- أيقونة الجرس في شريط التطبيق العلوي
- عرض عدد الإشعارات غير المقروءة
- قائمة منبثقة بآخر 5 تعليقات
- تحديث تلقائي كل 30 ثانية
- وضع علامة مقروء تلقائياً عند فتح القائمة

## دليل الاستخدام

### للعملاء (Clients)

1. **الوصول إلى الصفحة**
   - افتح `/client-review`
   - اختر "عميل" من خيارات العرض في الأعلى

2. **عرض التقارير**
   - سترى فقط التقارير المقبولة (Accepted)
   - انقر على "عرض التفاصيل" لأي تقرير

3. **إضافة تعليق**
   - اختر صورة معينة بالنقر على أيقونة التعليق
   - أو اكتب تعليق عام في صندوق النص
   - اضغط "إضافة تعليق"

4. **الرد على تعليق**
   - انقر على "رد" تحت التعليق المطلوب
   - اكتب ردك واضغط إرسال

### للمراجعين (Reviewers)

1. **الوصول إلى الصفحة**
   - افتح `/client-review`
   - اختر "مراجع" من خيارات العرض

2. **عرض جميع التقارير**
   - سترى جميع التقارير بجميع الحالات
   - راقب الإشعارات الجديدة في الجرس

3. **الرد على ملاحظات العملاء**
   - افتح التقرير
   - اقرأ تعليقات العميل
   - أضف ردودك أو حل المشاكل
   - غير حالة التعليق إلى "تم الحل" عند الانتهاء

### متابعة الإشعارات

1. **أيقونة الجرس**
   - توجد في الشريط العلوي
   - تظهر عدد الإشعارات الجديدة

2. **فتح الإشعارات**
   - انقر على الجرس
   - ستظهر قائمة بآخر 5 تعليقات
   - انقر على أي تعليق للانتقال إليه

## التخصيص والتطوير المستقبلي

### إضافة ميزات جديدة:

1. **إرفاق ملفات مع التعليقات**
```typescript
// في schema.prisma
model ClientComment {
  // ... الحقول الموجودة
  attachments String? @db.NVarChar(Max) // JSON array of file URLs
}
```

2. **إشعارات البريد الإلكتروني**
```typescript
// في API route
import { sendEmail } from '@/lib/email';

await sendEmail({
  to: clientEmail,
  subject: 'رد جديد على تعليقك',
  body: commentText
});
```

3. **تقارير الإحصائيات**
- عدد التعليقات لكل مكينة
- متوسط وقت الرد
- التعليقات المفتوحة/المحلولة

## استكشاف الأخطاء

### مشاكل شائعة:

1. **لا تظهر التعليقات**
   - تأكد من تطبيق migrations: `npx prisma db push`
   - تحقق من console في المتصفح

2. **الإشعارات لا تتحدث**
   - تأكد من تشغيل الخادم
   - تحقق من اتصال API

3. **صور لا تظهر**
   - تأكد من أن حالة التقرير "Accepted"
   - تحقق من روابط الصور

## الأمان والصلاحيات

- يجب إضافة نظام صلاحيات للتحكم في من يمكنه:
  - إضافة تعليقات
  - حذف تعليقات
  - تغيير حالة التعليقات
  - عرض تعليقات معينة

## الدعم والتواصل

للمزيد من المعلومات أو الإبلاغ عن مشاكل، يرجى التواصل مع فريق الدعم الفني.

---

**تاريخ الإنشاء:** 8 أكتوبر 2025
**الإصدار:** 1.0.0

