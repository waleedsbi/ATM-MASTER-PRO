# ุฅุตูุงุญ ูุดููุฉ ุงูุฃุณูุงุก ุงูุนุฑุจูุฉ ุจุนุฏ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ

## ๐ ุงููุดููุฉ

ุนูุฏ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุง ุชุธูุฑ ุงูุฃุณูุงุก ุงูุนุฑุจูุฉ ุจุดูู ุตุญูุญ ูู ุงููุธุงู (ุชุธูุฑ ูุนูุงูุงุช ุงุณุชููุงู `?????` ุฃู ุฑููุฒ ุบุฑูุจุฉ).

## ๐ ุงูุฃุณุจุงุจ ุงููุญุชููุฉ

1. **ุฅุนุฏุงุฏุงุช COLLATION ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ุงูุฌุฏุงูู ูุง ุชุณุชุฎุฏู COLLATION ูุฏุนู ุงูุนุฑุจูุฉ
2. **ุทุฑููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ**: ูู ูุชู ุงุณุชุฎุฏุงู ุงูุชุฑููุฒ ุงูุตุญูุญ (UTF-8/UTF-16)
3. **ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู**: Prisma Client ูุง ูุญุฏุฏ ุงูุชุฑููุฒ ุจุดูู ุตุญูุญ
4. **ููุน ุงูุจูุงูุงุช**: ุงูุญููู ูู ููุน `VARCHAR` ุจุฏูุงู ูู `NVARCHAR`

## โ ุงูุญู ุงูุดุงูู (ุฎุทูุฉ ุจุฎุทูุฉ)

### ุงูุฎุทูุฉ 1: ูุญุต ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุนุฏ ุงูุงุณุชุนุงุฏุฉ

ุงูุชุญ SQL Server Management Studio ููู ุจุชูููุฐ:

```sql
-- ูุญุต COLLATION ุงูุญุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช
SELECT 
    name AS DatabaseName,
    collation_name AS Collation
FROM sys.databases
WHERE name = DB_NAME();

-- ูุญุต COLLATION ููุฌุฏุงูู ุงููููุฉ
SELECT 
    t.name AS TableName,
    c.name AS ColumnName,
    ty.name AS DataType,
    c.collation_name AS Collation
FROM sys.tables t
INNER JOIN sys.columns c ON t.object_id = c.object_id
INNER JOIN sys.types ty ON c.user_type_id = ty.user_type_id
WHERE t.name IN ('BankATM', 'BankCode', 'GovernorateCode', 'CityCode')
    AND ty.name IN ('varchar', 'nvarchar', 'char', 'nchar', 'text', 'ntext')
ORDER BY t.name, c.name;
```

### ุงูุฎุทูุฉ 2: ุถุจุท COLLATION ููุงุนุฏุฉ ุงูุจูุงูุงุช (ุฅู ูุฒู ุงูุฃูุฑ)

โ๏ธ **ุชุญุฐูุฑ**: ุชูููุฐ ูุฐุง ุงูุณูุฑุจุช ุณูุบูุฑ COLLATION ููุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงููุงูู. ูู ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃููุงู!

```sql
-- ุชุบููุฑ COLLATION ููุงุนุฏุฉ ุงูุจูุงูุงุช
ALTER DATABASE [ุงุณู_ูุงุนุฏุฉ_ุงูุจูุงูุงุช] 
COLLATE Arabic_CI_AS;
```

**ููุงุญุธุฉ**: ูุฏ ุชุญุชุงุฌ ูุฅุนุงุฏุฉ ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅุฐุง ูุงูุช ุชุญุชูู ุนูู ุจูุงูุงุช.

### ุงูุฎุทูุฉ 3: ุชูููุฐ ุณูุฑุจุช ุฅุตูุงุญ ุงูุชุฑููุฒ

ูู ุจุชูููุฐ ุงูุณูุฑุจุช ุงูููุฌูุฏ ูู: `prisma/fix-arabic-encoding-after-restore.sql`

ูุฐุง ุงูุณูุฑุจุช ุณูููู ุจู:
- ุชุญููู ุฌููุน ุงูุญููู ุงููุตูุฉ ุงููููุฉ ุฅูู `NVARCHAR` ูุน `COLLATE Arabic_CI_AS`
- ุถุจุท COLLATION ููุฌุฏุงูู ุงูุฑุฆูุณูุฉ
- ูุญุต ูุฅุตูุงุญ ุงูุญููู ูู ุฌููุน ุงูุฌุฏุงูู ุงููููุฉ

### ุงูุฎุทูุฉ 4: ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู

ุชุฃูุฏ ูู ุฃู ููู `.env` ูุญุชูู ุนูู `DATABASE_URL` ุตุญูุญ:

```env
DATABASE_URL="sqlserver://username:password@server:1433;database=LinkSoft;encrypt=true;trustServerCertificate=true;connectionTimeout=30"
```

**ููุงุญุธุฉ**: Prisma ูุน SQL Server ูุง ูุฏุนู `charset` parameter ูุจุงุดุฑุฉ ูู connection stringุ ููู ุงุณุชุฎุฏุงู `NVARCHAR` ูุน `COLLATE Arabic_CI_AS` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูู.

### ุงูุฎุทูุฉ 5: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู

```bash
# ุฃููู ุงูุชุทุจูู (Ctrl+C)
# ุซู ุฃุนุฏ ุชุดุบููู
npm run dev
```

### ุงูุฎุทูุฉ 6: ุงูุชุญูู ูู ุงููุชุงุฆุฌ

ุงูุชุญ ูู ุงููุชุตูุญ:
```
http://localhost:9002/api/database/check-encoding
```

ูุฌุจ ุฃู ุชุฑู:
- `DATA_TYPE` = `nvarchar` (ูููุณ `varchar`)
- `COLLATION_NAME` ูุญุชูู ุนูู `Arabic_CI_AS`

## ๐ง ุทุฑููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ ุงูุตุญูุญุฉ

### ุนูุฏ ุฃุฎุฐ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:

**ูู SQL Server Management Studio:**
1. ุงููุฑ ุจุฒุฑ ุงููุงูุณ ุงูุฃููู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. Tasks โ Back Up...
3. ุชุฃูุฏ ูู:
   - **Backup type**: Full
   - **Backup component**: Database
   - **Destination**: ุงุฎุชุฑ ูุณุงุฑ ุงูููู

**ูู Command Line (sqlcmd):**
```bash
sqlcmd -S server_name -U username -P password -Q "BACKUP DATABASE [LinkSoft] TO DISK = 'C:\backup\LinkSoft.bak'"
```

### ุนูุฏ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:

**ูู SQL Server Management Studio:**
1. ุงููุฑ ุจุฒุฑ ุงููุงูุณ ุงูุฃููู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฃู Databases)
2. Restore Database...
3. ุงุฎุชุฑ "Device" ูุญุฏุฏ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
4. ูู ุชุจููุจ "Options":
   - โ **Overwrite the existing database**
   - โ **Preserve the replication settings** (ุฅู ูุฌุฏุช)

**ูู Command Line:**
```bash
sqlcmd -S server_name -U username -P password -Q "RESTORE DATABASE [LinkSoft] FROM DISK = 'C:\backup\LinkSoft.bak' WITH REPLACE"
```

**โ๏ธ ููู**: ุจุนุฏ ุงูุงุณุชุนุงุฏุฉุ ูู ุจุชูููุฐ ุณูุฑุจุช ุฅุตูุงุญ ุงูุชุฑููุฒ ููุฑุงู!

## ๐๏ธ ุญููู ุฅุถุงููุฉ

### ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุชุงููุฉ ุจุงููุนู:

ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุชุธูุฑ ูุนูุงูุงุช ุงุณุชููุงู `?????` ุจุนุฏ ุงูุงุณุชุนุงุฏุฉุ ููุฐุง ูุนูู ุฃู ุงูุจูุงูุงุช ุชุงููุฉ ููุง ูููู ุงุณุชุฑุฌุงุนูุง. ุงูุญููู:

1. **ุงุณุชุฎุฏุงู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃุฎุฑู** (ุฅู ูุฌุฏุช)
2. **ุฅุนุงุฏุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช** ูู ููู Excel/CSV ุงูุฃุตูู
3. **ุชุญุฏูุซ ูุฏูู** ููุจูุงูุงุช ุงูุชุงููุฉ:

```sql
UPDATE [dbo].[BankATM]
SET ATMAddress = N'ุงูุนููุงู ุงูุตุญูุญ'
WHERE ATMId = 'xxx';
```

**ููุงุญุธุฉ**: ุญุฑู `N` ูุจู ุงููุต ููู ุฌุฏุงู ูููุตูุต ุงูุนุฑุจูุฉ ูู SQL Server!

### ูุญุต ุงูุจูุงูุงุช ุงูุชุงููุฉ:

```sql
-- ุงูุจุญุซ ุนู ุงูุณุฌูุงุช ุงูุชู ุชุญุชูู ุนูู ุนูุงูุงุช ุงุณุชููุงู
SELECT 
    ATMId,
    ATMCode,
    ATMAddress,
    CASE 
        WHEN ATMAddress LIKE '%?%' THEN 'ุชุงูู'
        ELSE 'ุณููู'
    END AS Status
FROM [dbo].[BankATM]
WHERE ATMAddress LIKE '%?%';
```

## ๐ ุณูุฑุจุช SQL ุดุงูู ููุฅุตูุงุญ

ูู ุจุชูููุฐ ุงูุณูุฑุจุช ุงูููุฌูุฏ ูู: `prisma/fix-arabic-encoding-after-restore.sql`

ูุฐุง ุงูุณูุฑุจุช ุดุงูู ููุตูุญ:
- ุฌููุน ุงูุฌุฏุงูู ุงูุฑุฆูุณูุฉ (BankATM, BankCode, GovernorateCode, CityCode, ุฅูุฎ)
- ุฌููุน ุงูุญููู ุงููุตูุฉ ุงููููุฉ
- COLLATION ููุฌุฏุงูู

## โ ุงูุชุญูู ุงูููุงุฆู

ุจุนุฏ ุชุทุจูู ุฌููุน ุงูุฎุทูุงุช:

1. โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุณุชุฎุฏู `Arabic_CI_AS` COLLATION
2. โ ุฌููุน ุงูุญููู ุงููุตูุฉ ูู ููุน `NVARCHAR`
3. โ ุงูุจูุงูุงุช ุชุธูุฑ ุจุดูู ุตุญูุญ ูู SQL Server Management Studio
4. โ ุงูุจูุงูุงุช ุชุธูุฑ ุจุดูู ุตุญูุญ ูู ุงูุชุทุจูู

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

1. ุงูุชุญ `/api/database/check-encoding` ูุฃุฑุณู ุงููุชูุฌุฉ
2. ุชุญูู ูู console logs ูู ุงูุชุทุจูู
3. ุชุฃูุฏ ูู ุฃู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงูุฃุตููุฉ ูุงูุช ุชุญุชูู ุนูู ุจูุงูุงุช ุตุญูุญุฉ

## ๐ ููุงุญุธุงุช ูููุฉ

- **VARCHAR vs NVARCHAR**: 
  - `VARCHAR` = ASCII ููุท (ูุง ูุฏุนู ุงูุนุฑุจูุฉ)
  - `NVARCHAR` = Unicode (ูุฏุนู ุงูุนุฑุจูุฉ) โ

- **COLLATION**:
  - `Arabic_CI_AS` = Case Insensitive, Accent Sensitive (ููุตู ุจู ููุนุฑุจูุฉ)
  - `SQL_Latin1_General_CP1_CI_AS` = ูุง ูุฏุนู ุงูุนุฑุจูุฉ ุจุดูู ูุงูู โ

- **ุญุฑู N ูู SQL**:
  - `INSERT INTO Table (Name) VALUES ('ูุญูุฏ')` โ (ูุฏ ููุดู)
  - `INSERT INTO Table (Name) VALUES (N'ูุญูุฏ')` โ (ุตุญูุญ)

